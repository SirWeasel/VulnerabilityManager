import datetime
import json
from time import sleep
from threading import Thread
import pycve,vulners


from knowledgebase.models import KnowledgeBase


class KnowledgeBaseConnector:


    def __init__(self):
        self.vulners_api = vulners.Vulners()
        self.cve_search = pycve.CVE()


    def get_vulnerabilities(self, product_cpe):
        cpe_results = self.vulners_api.cpeVulnerabilities(product_cpe)
        cpe_exploit_list = cpe_results.get('exploit')
        cpe_vulnerabilities_list = [cpe_results.get(key) for key in cpe_results if
                                    key not in ['info', 'blog', 'bugbounty']]
        #with open('/tmp/scanresults','a+') as f:
        #    f.write("\nCPE VULNS:  ",str(cpe_exploit_list))
        #    f.write("\nOUT:  ",str(cpe_vulnerabilities_list))

        kb = KnowledgeBase.objects.create(kb_name="Test",cpe_exploit_list=cpe_exploit_list,
                                          cpe_vulnerabilities_list=cpe_vulnerabilities_list)

        kb.save()

