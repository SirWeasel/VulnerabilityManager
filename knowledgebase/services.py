import datetime
import json
from time import sleep
from threading import Thread
import vulners


from knowledgebase.models import KnowledgeBase


class KnowledgeBaseConnector:


    def __init__(self):
        self.vulners_api = vulners.Vulners()
        #self.cve_search = cve_search
        self.kb_list = []

    def get_vulnerabilities(self, product_cpe):
        cpe_results = self.vulners_api.cpeVulnerabilities(product_cpe)
        cpe_exploit_list = cpe_results.get('exploit')
        cpe_vulnerabilities_list = [cpe_results.get(key) for key in cpe_results if
                                    key not in ['info', 'blog', 'bugbounty']]

        kb, created = KnowledgeBase.objects.get_or_create(kb_name=str(product_cpe),exploit_list=str(cpe_exploit_list),
                                          vulnerability_list=str(cpe_vulnerabilities_list))
        if created:
            kb.save()

        self.kb_list.append(kb)

