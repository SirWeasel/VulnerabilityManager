# -*- coding: utf-8 -*-
from __future__ import unicode_literals

from django.contrib import admin

# Register your models here.
from django.http import HttpResponseRedirect
from django.utils.html import format_html
from django.urls import reverse
from django.utils.safestring import mark_safe

from scans.models import Scan, ScanProfile, Result
from scans.services import ScanTool


class ScanAdmin(admin.ModelAdmin):
    list_display = [f.name for f in Scan._meta.fields if "id" not in f.name]
    readonly_fields = ["status","create_date","last_scan","result"]



    def launch_scan(self, request, queryset):

        scan_tool = ScanTool()

        scan_tool.activate_scans(queryset)

        return HttpResponseRedirect("/scans/scan")


    launch_scan.short_description = "Launch scan(s)"
    actions = [launch_scan]
    search_fields = ('scan_title', )


    class Meta:
        model = Scan



class ScanProfileAdmin(admin.ModelAdmin):
    list_display = [f.name for f in ScanProfile._meta.fields  if "id" not in f.name]


    class Meta:
        model = ScanProfile
    class Media:
        js = ('/static/admin/js/hide_atribute.js',)


class ResultsAdmin(admin.ModelAdmin):
    list_display = [f.name for f in Result._meta.fields  if "id" not in f.name]

    readonly_fields = ["xml_data","create_date","knowledgebase"]

    def knowledgebase(self,obj):
        display_text = ", ".join([
            "<a href={}>{}</a>".format(
                reverse('admin:{}_{}_change'.format(obj._meta.app_label, obj._meta.model_name),
                        args=(kb.pk,)),
                kb.kb_name)
            for kb in obj.knowledgebase.all()
        ])
        if display_text:
            return mark_safe(display_text)
        return "-"
    class Meta:
        model = Result


admin.site.register(Scan, ScanAdmin)
admin.site.register(ScanProfile,ScanProfileAdmin)
admin.site.register(Result, ResultsAdmin)
