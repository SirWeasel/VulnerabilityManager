# -*- coding: utf-8 -*-
from __future__ import unicode_literals

from django.contrib import admin

# Register your models here.
from django.http import HttpResponseRedirect
from django.utils.html import format_html
from django.urls import reverse
from scans.models import Scan, ScanProfile, Result
from scans.services import ScanTool


class ScanAdmin(admin.ModelAdmin):
    list_display = [f.name for f in Scan._meta.fields if "id" not in f.name]
    readonly_fields = ["status","create_date","last_scan","result"]

    def result(self, obj):
        try:
            print("ceva")
            link = reverse("admin:scans_result_change",args=[obj.result.id])
            print(link)
            return format_html("<a href='{0}'>{1}</a>", link, obj.result.result_title)
        except:
            return None
    result.allow_tags = True


    def launch_scan(self, request, queryset):

        scan_tool = ScanTool()

        scan_tool.activate_scans(queryset)

        return HttpResponseRedirect("/scans/scan")

    launch_scan.short_description = "Launch scan(s)"
    actions = [launch_scan]



    class Meta:
        model = Scan



class ScanProfileAdmin(admin.ModelAdmin):
    list_display = [f.name for f in ScanProfile._meta.fields  if "id" not in f.name]

    class Meta:
        model = ScanProfile

class ResultsAdmin(admin.ModelAdmin):
    list_display = [f.name for f in Result._meta.fields  if "id" not in f.name]
    readonly_fields = ["html_data","xml_data"]

    class Meta:
        model = Result


admin.site.register(Scan, ScanAdmin)
admin.site.register(ScanProfile,ScanProfileAdmin)
admin.site.register(Result, ResultsAdmin)
